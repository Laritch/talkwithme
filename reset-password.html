<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password - Enhanced Chat System</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f5f7fb;
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .reset-container {
            background-color: #fff;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            width: 400px;
            padding: 40px;
            text-align: center;
        }

        .logo {
            font-size: 26px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 20px;
        }

        .subtitle {
            color: #6c757d;
            margin-bottom: 30px;
        }

        .steps {
            display: flex;
            margin-bottom: 30px;
            position: relative;
            justify-content: space-between;
        }

        .steps::before {
            content: '';
            position: absolute;
            top: 16px;
            left: 0;
            right: 0;
            height: 2px;
            background-color: #e1e1e1;
            z-index: 0;
        }

        .step {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background-color: #e1e1e1;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            position: relative;
            z-index: 1;
        }

        .step.active {
            background-color: #667eea;
            color: white;
        }

        .step.completed {
            background-color: #4CAF50;
            color: white;
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }

        input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ced4da;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 16px;
        }

        input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.25);
        }

        .btn {
            display: inline-block;
            background-color: #667eea;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            width: 100%;
            transition: background-color 0.3s;
        }

        .btn:hover {
            background-color: #5a70d8;
        }

        .btn:disabled {
            background-color: #b5bfd9;
            cursor: not-allowed;
        }

        .back-link {
            display: block;
            margin-top: 20px;
            color: #667eea;
            text-decoration: none;
        }

        .error-message {
            color: #dc3545;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .success-message {
            color: #28a745;
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            border-radius: 5px;
            padding: 10px;
            margin-bottom: 20px;
            display: none;
        }

        .password-requirements {
            margin-top: 10px;
            font-size: 14px;
            color: #6c757d;
        }

        .requirement {
            display: flex;
            align-items: center;
            margin-bottom: 3px;
        }

        .requirement i {
            margin-right: 5px;
            font-size: 12px;
        }

        .requirement.met i {
            color: #4CAF50;
        }

        .requirement.unmet i {
            color: #6c757d;
        }

        /* Progress bar styles */
        .timer-container {
            margin-top: 20px;
            text-align: center;
        }

        .timer-text {
            font-size: 14px;
            color: #6c757d;
            margin-bottom: 5px;
        }

        .progress-container {
            height: 5px;
            background-color: #e1e1e1;
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }

        .progress-bar {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            background-color: #667eea;
            border-radius: 5px;
            transition: width 1s linear;
        }

        /* Loader */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
            vertical-align: middle;
            display: none;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Mobile Responsiveness */
        @media screen and (max-width: 480px) {
            body {
                padding: 20px;
                align-items: flex-start;
                padding-top: 30px;
            }

            .reset-container {
                width: 100%;
                padding: 25px 15px;
                box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            }

            .logo {
                font-size: 22px;
                margin-bottom: 15px;
            }

            .subtitle {
                font-size: 14px;
                margin-bottom: 20px;
            }

            .steps {
                margin-bottom: 25px;
            }

            .step {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }

            h2 {
                font-size: 18px;
                margin-bottom: 8px;
            }

            p {
                font-size: 14px;
                margin-bottom: 15px;
            }

            .form-group {
                margin-bottom: 15px;
            }

            label {
                margin-bottom: 3px;
                font-size: 14px;
            }

            input {
                padding: 10px;
                font-size: 14px;
            }

            .password-requirements {
                font-size: 12px;
            }

            .btn {
                padding: 10px 15px;
                font-size: 14px;
            }

            .back-link {
                margin-top: 15px;
                font-size: 14px;
            }

            .timer-container {
                margin-top: 15px;
            }

            .timer-text {
                font-size: 12px;
            }
        }

        /* Landscape mode for small devices */
        @media screen and (max-height: 480px) and (orientation: landscape) {
            body {
                padding: 10px;
                align-items: center;
            }

            .reset-container {
                width: 90%;
                max-width: 450px;
                padding: 20px;
            }

            .steps {
                margin-bottom: 15px;
            }

            .step-content h2 {
                font-size: 16px;
                margin-bottom: 5px;
            }

            .step-content p {
                margin-bottom: 10px;
            }

            .form-group {
                margin-bottom: 10px;
            }

            input {
                padding: 8px;
            }

            .password-requirements {
                margin-top: 5px;
            }

            .timer-container {
                margin-top: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="reset-container">
        <div class="logo">
            <i class="fas fa-comments"></i> Enhanced Chat
        </div>
        <p class="subtitle">Reset your password</p>

        <div class="error-message" id="error-message"></div>
        <div class="success-message" id="success-message"></div>

        <div class="steps">
            <div class="step active" id="step-1">1</div>
            <div class="step" id="step-2">2</div>
            <div class="step" id="step-3">3</div>
        </div>

        <!-- Step 1: Enter Email -->
        <div class="step-content active" id="step-1-content">
            <h2>Enter your email</h2>
            <p>We'll send you a verification code to reset your password.</p>

            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="your@email.com" required>
            </div>

            <button class="btn" id="send-code-btn">
                <span class="loader" id="send-code-loader"></span>
                Send Verification Code
            </button>
        </div>

        <!-- Step 2: Enter Verification Code -->
        <div class="step-content" id="step-2-content">
            <h2>Enter verification code</h2>
            <p>A 6-digit code has been sent to your email.</p>

            <div class="form-group">
                <label for="verification-code">Verification Code</label>
                <input type="text" id="verification-code" maxlength="6" placeholder="XXXXXX" required>
            </div>

            <div class="timer-container">
                <div class="timer-text" id="timer-text">Code expires in: 10:00</div>
                <div class="progress-container">
                    <div class="progress-bar" id="progress-bar" style="width: 100%;"></div>
                </div>
            </div>

            <button class="btn" id="verify-code-btn">
                <span class="loader" id="verify-code-loader"></span>
                Verify Code
            </button>

            <button class="btn" id="resend-code-btn" style="background-color: transparent; color: #667eea; margin-top: 10px;" disabled>
                Resend Code (<span id="resend-timer">60</span>s)
            </button>
        </div>

        <!-- Step 3: Create New Password -->
        <div class="step-content" id="step-3-content">
            <h2>Create new password</h2>
            <p>Your password must be at least 6 characters long.</p>

            <div class="form-group">
                <label for="new-password">New Password</label>
                <input type="password" id="new-password" placeholder="Enter new password" required>

                <div class="password-requirements" id="password-requirements">
                    <div class="requirement unmet" id="req-length">
                        <i class="fas fa-circle"></i> At least 6 characters
                    </div>
                    <div class="requirement unmet" id="req-uppercase">
                        <i class="fas fa-circle"></i> At least 1 uppercase letter
                    </div>
                    <div class="requirement unmet" id="req-number">
                        <i class="fas fa-circle"></i> At least 1 number
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label for="confirm-password">Confirm Password</label>
                <input type="password" id="confirm-password" placeholder="Confirm new password" required>
            </div>

            <button class="btn" id="reset-password-btn">
                <span class="loader" id="reset-password-loader"></span>
                Reset Password
            </button>
        </div>

        <a href="/login.html" class="back-link">Back to Login</a>
    </div>

    <script src="js/util.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const steps = document.querySelectorAll('.step');
            const stepContents = document.querySelectorAll('.step-content');
            const errorMessage = document.getElementById('error-message');
            const successMessage = document.getElementById('success-message');

            // Current step
            let currentStep = 1;
            let verificationToken = '';
            let emailAddress = '';
            let resendTimer;
            let codeExpiryTimer;

            // Show/hide error message
            function showError(message) {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                successMessage.style.display = 'none';
            }

            // Show/hide success message
            function showSuccess(message) {
                successMessage.textContent = message;
                successMessage.style.display = 'block';
                errorMessage.style.display = 'none';
            }

            // Clear messages
            function clearMessages() {
                errorMessage.style.display = 'none';
                successMessage.style.display = 'none';
            }

            // Navigate to specific step
            function goToStep(step) {
                clearMessages();

                steps.forEach((el, index) => {
                    if (index + 1 < step) {
                        el.classList.remove('active');
                        el.classList.add('completed');
                    } else if (index + 1 === step) {
                        el.classList.add('active');
                        el.classList.remove('completed');
                    } else {
                        el.classList.remove('active');
                        el.classList.remove('completed');
                    }
                });

                stepContents.forEach((el, index) => {
                    if (index + 1 === step) {
                        el.classList.add('active');
                    } else {
                        el.classList.remove('active');
                    }
                });

                currentStep = step;
            }

            // Handle send verification code
            document.getElementById('send-code-btn').addEventListener('click', async function() {
                const email = document.getElementById('email').value.trim();

                if (!email) {
                    showError('Please enter your email address');
                    return;
                }

                if (!isValidEmail(email)) {
                    showError('Please enter a valid email address');
                    return;
                }

                // Show loader
                const loader = document.getElementById('send-code-loader');
                const button = document.getElementById('send-code-btn');
                loader.style.display = 'inline-block';
                button.disabled = true;

                try {
                    // Make API request to send verification code
                    const response = await fetch('/api/users/forgot-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || 'Failed to send verification code');
                    }

                    // Store email and verification token
                    emailAddress = email;
                    verificationToken = data.token;

                    // Show success message and go to next step
                    showSuccess('Verification code sent! Please check your email.');
                    goToStep(2);

                    // Start countdown for resend button
                    startResendCountdown();

                    // Start countdown for code expiry
                    startExpiryCountdown();

                } catch (error) {
                    showError(error.message || 'An error occurred. Please try again.');
                } finally {
                    // Hide loader
                    loader.style.display = 'none';
                    button.disabled = false;
                }
            });

            // Handle verify code
            document.getElementById('verify-code-btn').addEventListener('click', async function() {
                const code = document.getElementById('verification-code').value.trim();

                if (!code) {
                    showError('Please enter the verification code');
                    return;
                }

                if (code.length !== 6 || !/^\d+$/.test(code)) {
                    showError('Please enter a valid 6-digit code');
                    return;
                }

                // Show loader
                const loader = document.getElementById('verify-code-loader');
                const button = document.getElementById('verify-code-btn');
                loader.style.display = 'inline-block';
                button.disabled = true;

                try {
                    // Make API request to verify code
                    const response = await fetch('/api/users/verify-reset-code', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: emailAddress,
                            code,
                            token: verificationToken
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || 'Invalid verification code');
                    }

                    // Store new token if provided
                    if (data.token) {
                        verificationToken = data.token;
                    }

                    // Show success message and go to next step
                    showSuccess('Code verified successfully!');
                    goToStep(3);

                    // Clear the expiry timer
                    if (codeExpiryTimer) {
                        clearInterval(codeExpiryTimer);
                    }

                } catch (error) {
                    showError(error.message || 'Invalid verification code. Please try again.');
                } finally {
                    // Hide loader
                    loader.style.display = 'none';
                    button.disabled = false;
                }
            });

            // Handle resend code
            document.getElementById('resend-code-btn').addEventListener('click', async function() {
                if (this.disabled) return;

                // Show loader and disable button
                this.disabled = true;

                try {
                    // Make API request to resend verification code
                    const response = await fetch('/api/users/resend-verification', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ email: emailAddress })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || 'Failed to resend code');
                    }

                    // Update verification token if provided
                    if (data.token) {
                        verificationToken = data.token;
                    }

                    // Show success message
                    showSuccess('A new verification code has been sent to your email.');

                    // Reset and start the resend countdown again
                    startResendCountdown();

                    // Reset and start the expiry countdown
                    startExpiryCountdown();

                } catch (error) {
                    showError(error.message || 'Failed to resend verification code.');
                }
            });

            // Handle password reset
            document.getElementById('reset-password-btn').addEventListener('click', async function() {
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;

                // Validate password
                if (!validatePassword(newPassword)) {
                    showError('Please make sure your password meets all requirements.');
                    return;
                }

                // Check if passwords match
                if (newPassword !== confirmPassword) {
                    showError('Passwords do not match.');
                    return;
                }

                // Show loader
                const loader = document.getElementById('reset-password-loader');
                const button = document.getElementById('reset-password-btn');
                loader.style.display = 'inline-block';
                button.disabled = true;

                try {
                    // Make API request to reset password
                    const response = await fetch('/api/users/reset-password', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            email: emailAddress,
                            token: verificationToken,
                            password: newPassword
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        throw new Error(data.message || 'Failed to reset password');
                    }

                    // Show success message
                    showSuccess('Your password has been reset successfully! Redirecting to login...');

                    // Redirect to login page after a short delay
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 3000);

                } catch (error) {
                    showError(error.message || 'Failed to reset password. Please try again.');
                } finally {
                    // Hide loader
                    loader.style.display = 'none';
                    button.disabled = false;
                }
            });

            // Password requirements checker
            document.getElementById('new-password').addEventListener('input', function() {
                const password = this.value;
                checkPasswordRequirements(password);
            });

            // Check password requirements
            function checkPasswordRequirements(password) {
                const lengthReq = document.getElementById('req-length');
                const uppercaseReq = document.getElementById('req-uppercase');
                const numberReq = document.getElementById('req-number');

                // Check length
                if (password.length >= 6) {
                    lengthReq.classList.remove('unmet');
                    lengthReq.classList.add('met');
                } else {
                    lengthReq.classList.remove('met');
                    lengthReq.classList.add('unmet');
                }

                // Check uppercase
                if (/[A-Z]/.test(password)) {
                    uppercaseReq.classList.remove('unmet');
                    uppercaseReq.classList.add('met');
                } else {
                    uppercaseReq.classList.remove('met');
                    uppercaseReq.classList.add('unmet');
                }

                // Check number
                if (/\d/.test(password)) {
                    numberReq.classList.remove('unmet');
                    numberReq.classList.add('met');
                } else {
                    numberReq.classList.remove('met');
                    numberReq.classList.add('unmet');
                }
            }

            // Validate password meets all requirements
            function validatePassword(password) {
                return password.length >= 6 && /[A-Z]/.test(password) && /\d/.test(password);
            }

            // Check if email is valid
            function isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            // Start resend countdown (60 seconds)
            function startResendCountdown() {
                const resendBtn = document.getElementById('resend-code-btn');
                const timerEl = document.getElementById('resend-timer');
                let timeLeft = 60;

                timerEl.textContent = timeLeft;
                resendBtn.disabled = true;

                // Clear existing timer if any
                if (resendTimer) {
                    clearInterval(resendTimer);
                }

                // Start new timer
                resendTimer = setInterval(() => {
                    timeLeft--;
                    timerEl.textContent = timeLeft;

                    if (timeLeft <= 0) {
                        clearInterval(resendTimer);
                        resendBtn.disabled = false;
                    }
                }, 1000);
            }

            // Start code expiry countdown (10 minutes)
            function startExpiryCountdown() {
                const timerText = document.getElementById('timer-text');
                const progressBar = document.getElementById('progress-bar');
                const totalTime = 10 * 60; // 10 minutes in seconds
                let timeLeft = totalTime;

                // Clear existing timer if any
                if (codeExpiryTimer) {
                    clearInterval(codeExpiryTimer);
                }

                // Start new timer
                updateExpiryDisplay();
                progressBar.style.width = '100%';

                codeExpiryTimer = setInterval(() => {
                    timeLeft--;

                    // Update display
                    updateExpiryDisplay();

                    // Update progress bar
                    const percentage = (timeLeft / totalTime) * 100;
                    progressBar.style.width = `${percentage}%`;

                    if (timeLeft <= 0) {
                        clearInterval(codeExpiryTimer);
                        showError('Verification code has expired. Please request a new one.');
                        document.getElementById('verify-code-btn').disabled = true;
                    }
                }, 1000);

                function updateExpiryDisplay() {
                    const minutes = Math.floor(timeLeft / 60);
                    const seconds = timeLeft % 60;
                    timerText.textContent = `Code expires in: ${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
                }
            }
        });
    </script>
</body>
</html>
